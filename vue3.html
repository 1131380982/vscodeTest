<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>

<body>
    <div id="app">
        <P>{{model.name}}</P>
        <input type="text" v-model="model.name" />
        <input type="text" v-model="userlist[0].address[0].city" />
        <input type="text" v-model="userlist[0].address[0].city" />
        <button v-on:click='sayHi'>change model</button>
    </div>
    <script>
        (function (global, factory) {
            global.Vue = factory();
        })(this, function () {
            var Vue = function (options) { 
                if (typeof options != "object") {
                    console.log('请传入一个对象');
                    return;
                }
                this._databing = {};
                for (item in options.data) {
                    this[item] = options.data[item];
                    this.observe(this[item], item);
                }
                this.$el = document.querySelector(options.el);
                this.$methods = options.methods;
               // console.log('-------------------------');
                this._compile(this.$el);

            };
            Vue.prototype.observe = function (data, _dataname) {
                var _this = this;
                var isarr = Array.isArray(data);

                Object.keys(data).forEach((key) => {

                    var dataname = _dataname;
                    if (isarr) {
                        dataname = dataname + "[" + key + "]";
                    } else {
                        dataname = dataname + "." + key;
                    }
                    if (data[key] && (typeof data[key] == 'object')) {
                        _this.observe(data[key], dataname);
                        return;
                    }


                    _this._databing[dataname] = {
                        dataname: dataname,
                        update: []
                    };
                    var val = data[key];
                    var binding = _this._databing[dataname];
                    // console.log(dataname);
                    Object.defineProperty(data, key, {
                        enumerable: true, // 可枚举--可被for-in和Object.keys()枚举。
                        configurable: false, // 目标属性不能被删除和不能修再被改特性
                        get: function () {
                            return val;
                        },
                        set: (function (newVal) {
                            val = newVal;
                            //console.log(binding);
                            binding.update.forEach(function (item) {
                                item.update();
                            });

                        })
                    })
                });
            };
            Vue.prototype._compile = function (el) {
                var _this = this;
                var nodes = el.children;
                for (var i = 0; i < nodes.length; i++) {
                    var node = nodes[i];
                    if (node.children.length) { _this._compile(node) }
                    var attrs = node.attributes;//属性集合
                    var attrslength = attrs.length;

                    for (var j = 0; j < attrslength; j++) {
                        var AttrName = attrs[j].nodeName;  //属性名

                        if (AttrName.indexOf("v-on") > -1) { //绑定on事件
                            var event = AttrName.substring(AttrName.indexOf(":") + 1);
                            node.addEventListener(event, _this.$methods[node.getAttribute(AttrName)], false)
                        }


                        if (AttrName == 'v-model' && (node.tagName == "INPUT" || node.tagName == "TEXTAREA")) {
                            {
                                var attrVal = node.getAttribute(AttrName); //user[0]
                                var attrVals = attrVal.split(".");
                                var name = attrVals[attrVals.length - 1]
                                var _value = _this;
                                for (var a = 0; a < attrVals.length - 1; a++) {

                                    if (attrVals[a].indexOf("[") > -1 && attrVals[a].indexOf("]") > -1) {
                                        var model = attrVals[a].substring(0, attrVals[a].indexOf("["));
                                        _value = attrsArr(_value[model], attrVals[a]);
                                    } else {
                                        _value = _value[attrVals[a]];
                                    }
                                }

                                _this._databing[attrVal].update.push(new watcher(
                                    'input',
                                    node,
                                    _this,
                                    _value,
                                    name,
                                    'value'
                                ));
                            }
                            {
                                node.addEventListener('input', function (e) {
                                    var attrVal = this.getAttribute('v-model');
                                    console.log(attrVal);
                                    var attrVals = attrVal.split(".");
                                    var name = attrVals[attrVals.length - 1]
                                    var _value = _this;
                                    for (var a = 0; a < attrVals.length - 1; a++) {

                                        if (attrVals[a].indexOf("[") > -1 && attrVals[a].indexOf("]") > -1) {
                                            var model = attrVals[a].substring(0, attrVals[a].indexOf("["));
                                            _value = attrsArr(_value[model], attrVals[a]);
                                        } else {
                                            _value = _value[attrVals[a]];
                                        }
                                    }
                                    _value[name] = this.value;
                                });
                            };
                        }
                    }
                    var innerHTML = node.innerHTML;
                    if (innerHTML.indexOf("{{") > -1 && innerHTML.indexOf("}}") > -1) {  //处理{{XXXX}} 模板
                        var attrVal = innerHTML.substring(innerHTML.indexOf("{{") + 2, innerHTML.indexOf("}}"))
                        var attrs = attrVal.split(".");
                        var name = attrs[attrs.length - 1]
                        var _value = _this;
                        for (var a = 0; a < attrs.length - 1; a++) {
                            if (attrs[a].indexOf("[") > -1 && attrs[a].indexOf("]") > -1) {
                                var model = attrs[a].substring(0, attrs[a].indexOf("["));
                                _value = attrsArr(_value[model], attrs[a]);
                            } else {
                                _value = _value[attrs[a]];
                            }
                        }
                        _this._databing[attrVal].update.push(new watcher(
                            'input',
                            node,
                            _this,
                            _value,
                            name,
                            'innerHTML'
                        ));
                    }
                }
            };
            function attrsArr(obj, str) {
                if (str.indexOf("[") > -1 && str.indexOf("]") > -1) {
                    var number = parseInt(str.substring(str.indexOf("[") + 1, str.indexOf("]")));
                    str = str.substring(str.indexOf("]") + 1);
                    return attrsArr(obj[number], str);
                }
                return obj;

            }
            function watcher(name, el, vm, obj, objname, attr) {
                this.name = name;//指令名称--这里还没有用到
                this.el = el;//指令对应的DOM元素
                this.obj = obj;//指令对应的值--也就是指令所对应的data中的属性名
                this.objname = objname;//指令对应的值--也就是指令所对应的data中的属性名
                this.attr = attr;//属性值
                this.update = function () {
                    this.el[this.attr] = this.obj[this.objname];
                }
                //实例该对象的时候执行更新dom方法
                this.update();
            };
            return Vue;
        });

        var vue1 = new Vue({
            el: "#app",
            data: {
                model: { name: "name1" },
                userlist: [
                    { name: "user1", address: [{ city: "深圳" }, { city: "南昌" }, { city: "北京" }] },
                    { name: "user2", address: [{ city: "深圳" }, { city: "南昌" }, { city: "北京" }] },
                ],

            },
            methods: {
                sayHi: function () {
                    console.log(1);
                }
            }

        });
        console.log(vue1)
    </script>
</body>

</html>